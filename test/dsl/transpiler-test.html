<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DSL Transpiler Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 {
      color: #4EC9B0;
    }
    .test-case {
      margin: 20px 0;
      padding: 16px;
      background: #2d2d30;
      border-radius: 4px;
    }
    .test-case h3 {
      margin-top: 0;
      color: #4EC9B0;
    }
    pre {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 3px;
      overflow-x: auto;
      border-left: 3px solid #4EC9B0;
    }
    .result {
      margin-top: 12px;
    }
    .pass {
      color: #4CAF50;
      font-weight: bold;
    }
    .fail {
      color: #f44336;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>DSL Transpiler Test</h1>

  <div id="test-results"></div>

  <script src="transpiler.js"></script>
  <script>
    const transpiler = new DSLTranspiler();

    const tests = [
      {
        name: 'TYPE command',
        input: 'TYPE "Hello World"',
        expected: "fixture.type('Hello World');"
      },
      {
        name: 'PRESS single character',
        input: 'PRESS a',
        expected: "fixture.press('a').once();"
      },
      {
        name: 'PRESS quoted space',
        input: 'PRESS " "',
        expected: "fixture.press(' ').once();"
      },
      {
        name: 'PRESS quoted semicolon',
        input: 'PRESS ";"',
        expected: "fixture.press(';').once();"
      },
      {
        name: 'Backspace once (implicit)',
        input: 'backspace',
        expected: 'fixture.press(Key.Backspace).once();'
      },
      {
        name: 'Backspace 5 times',
        input: 'backspace 5 times',
        expected: 'fixture.press(Key.Backspace).times(5);'
      },
      {
        name: 'Enter once',
        input: 'enter once',
        expected: 'fixture.press(Key.Enter).once();'
      },
      {
        name: 'Left with meta',
        input: 'left with meta',
        expected: 'fixture.press(Key.ArrowLeft).withMetaKey().once();'
      },
      {
        name: 'Right with shift',
        input: 'right with shift',
        expected: 'fixture.press(Key.ArrowRight).withShiftKey().once();'
      },
      {
        name: 'Right 5 times with shift',
        input: 'right 5 times with shift',
        expected: 'fixture.press(Key.ArrowRight).withShiftKey().times(5);'
      },
      {
        name: 'Right with meta, shift (normalized order)',
        input: 'right with meta, shift',
        expected: 'fixture.press(Key.ArrowRight).withMetaKey().withShiftKey().once();'
      },
      {
        name: 'Up 2 times',
        input: 'up 2 times',
        expected: 'fixture.press(Key.ArrowUp).times(2);'
      },
      {
        name: 'JavaScript pass-through',
        input: 'expect(fixture).toHaveLines("Hello");',
        expected: 'expect(fixture).toHaveLines("Hello");'
      },
      {
        name: 'Empty line',
        input: '',
        expected: ''
      },
      {
        name: 'Multi-line DSL',
        input: `TYPE "Hello"
enter
TYPE "World"`,
        expected: `fixture.type('Hello');
fixture.press(Key.Enter).once();
fixture.type('World');`
      },
      {
        name: 'JavaScript interweaving: DSL with expect',
        input: `TYPE "Hello"
expect(fixture).toHaveLines('Hello');`,
        expected: `fixture.type('Hello');
expect(fixture).toHaveLines('Hello');`
      },
      {
        name: 'JavaScript interweaving: variable declaration',
        input: `TYPE "Test"
const text = fixture.wb.Model.lines[0];
expect(text).toBe('Test');`,
        expected: `fixture.type('Test');
const text = fixture.wb.Model.lines[0];
expect(text).toBe('Test');`
      },
      {
        name: 'JavaScript interweaving: selection check',
        input: `TYPE "Hello"
left 3 times with shift
const [start, end] = fixture.wb.Selection.ordered;
expect(start).toEqual({ row: 0, col: 2 });
expect(end).toEqual({ row: 0, col: 5 });`,
        expected: `fixture.type('Hello');
fixture.press(Key.ArrowLeft).withShiftKey().times(3);
const [start, end] = fixture.wb.Selection.ordered;
expect(start).toEqual({ row: 0, col: 2 });
expect(end).toEqual({ row: 0, col: 5 });`
      },
      {
        name: 'JavaScript interweaving: with empty lines',
        input: `TYPE "Hello"

const text = fixture.wb.Model.lines[0];
expect(text).toBe('Hello');

backspace 5 times

expect(fixture).toHaveLines('');`,
        expected: `fixture.type('Hello');

const text = fixture.wb.Model.lines[0];
expect(text).toBe('Hello');

fixture.press(Key.Backspace).times(5);

expect(fixture).toHaveLines('');`
      },
      {
        name: 'JavaScript interweaving: multi-line editing with checks',
        input: `TYPE "First"
enter
TYPE "Second"
expect(fixture).toHaveLines('First', 'Second');
up
TYPE " Line"
expect(fixture).toHaveLines('First Line', 'Second');`,
        expected: `fixture.type('First');
fixture.press(Key.Enter).once();
fixture.type('Second');
expect(fixture).toHaveLines('First', 'Second');
fixture.press(Key.ArrowUp).once();
fixture.type(' Line');
expect(fixture).toHaveLines('First Line', 'Second');`
      },
      {
        name: 'JavaScript interweaving: complex selection scenario',
        input: `TYPE "Hello World"
left with meta
right 5 times with shift
expect(fixture.wb.Selection.isSelection).toBe(true);
TYPE "X"
expect(fixture.wb.Selection.isSelection).toBe(false);
expect(fixture).toHaveLines('XWorld');`,
        expected: `fixture.type('Hello World');
fixture.press(Key.ArrowLeft).withMetaKey().once();
fixture.press(Key.ArrowRight).withShiftKey().times(5);
expect(fixture.wb.Selection.isSelection).toBe(true);
fixture.type('X');
expect(fixture.wb.Selection.isSelection).toBe(false);
expect(fixture).toHaveLines('XWorld');`
      },
      {
        name: 'EXPECT cursor at command',
        input: 'EXPECT cursor at 0,1',
        expected: 'expect(fixture).toHaveCursorAt(0, 1);'
      },
      {
        name: 'EXPECT cursor at with spaces',
        input: 'EXPECT cursor at 2, 5',
        expected: 'expect(fixture).toHaveCursorAt(2, 5);'
      },
      {
        name: 'EXPECT cursor at in context',
        input: `TYPE "Hello"
EXPECT cursor at 0,5`,
        expected: `fixture.type('Hello');
expect(fixture).toHaveCursorAt(0, 5);`
      },
      {
        name: 'EXPECT cursor at with non-numeric row (should fail)',
        input: 'EXPECT cursor at foobar,1',
        expectedError: 'Invalid EXPECT cursor at command: expect cursor at foobar,1'
      },
      {
        name: 'EXPECT cursor at with non-numeric col (should fail)',
        input: 'EXPECT cursor at 0,abc',
        expectedError: 'Invalid EXPECT cursor at command: expect cursor at 0,abc'
      },
      {
        name: 'EXPECT selection at command',
        input: 'EXPECT selection at 1,2-4,5',
        expected: 'expect(fixture).toHaveSelectionAt(1, 2, 4, 5);'
      },
      {
        name: 'EXPECT selection at with spaces',
        input: 'EXPECT selection at 0, 1 - 2, 3',
        expected: 'expect(fixture).toHaveSelectionAt(0, 1, 2, 3);'
      },
      {
        name: 'EXPECT selection at in context',
        input: `TYPE "Hello World"
left 5 times with shift
EXPECT selection at 0,6-0,11`,
        expected: `fixture.type('Hello World');
fixture.press(Key.ArrowLeft).withShiftKey().times(5);
expect(fixture).toHaveSelectionAt(0, 6, 0, 11);`
      },
      {
        name: 'EXPECT selection at with invalid format (should fail)',
        input: 'EXPECT selection at 1,2',
        expectedError: 'Invalid EXPECT selection at command: expect selection at 1,2'
      },
      {
        name: 'EXPECT selection at with non-numeric values (should fail)',
        input: 'EXPECT selection at a,b-c,d',
        expectedError: 'Invalid EXPECT selection at command: expect selection at a,b-c,d'
      },
       {
        name: 'type command should be case insensitive',
        input: 'tYpe "foobar"',
        expected: "fixture.type('foobar');",
      },
      {
        name: 'type command should preserve case sensitivity of string',
        input: 'tYpe "fooBar"',
        expected: "fixture.type('fooBar');",
      },
     {
        name: 'press command should be case insensitive',
        input: 'press a',
        expected: "fixture.press('a').once();",
      },
      {
        name: 'type command should preserve case sensitivity of character',
        input: 'press B',
        expected: "fixture.press('B').once();",
      },
      {
        name: 'PRESS unquoted comma (should fail)',
        input: 'PRESS ,',
        expectedError: "Comma must be quoted in PRESS command: use PRESS ',' instead of PRESS ,"
      },
      {
        name: 'PRESS double-quoted comma',
        input: 'PRESS ","',
        expected: "fixture.press(',').once();"
      },
      {
        name: "PRESS single-quoted comma",
        input: "PRESS ','",
        expected: "fixture.press(',').once();"
      },
      {
        name: 'PRESS unquoted comma with quantification (should fail)',
        input: 'PRESS , 3 times',
        expectedError: "Comma must be quoted in PRESS command: use PRESS ',' instead of PRESS ,"
      },
      {
        name: 'PRESS quoted comma with quantification',
        input: 'PRESS "," 3 times',
        expected: "fixture.press(',').times(3);"
      },
      {
        name: 'PRESS double-quoted space',
        input: 'PRESS " "',
        expected: "fixture.press(' ').once();"
      },
      {
        name: "PRESS single-quoted space",
        input: "PRESS ' '",
        expected: "fixture.press(' ').once();"
      },
      {
        name: 'PRESS unquoted space (should fail - ambiguous)',
        input: 'PRESS  ',
        expectedError: "Invalid PRESS command: press  "
      },
      {
        name: 'PRESS double-quoted space with quantification',
        input: 'PRESS " " 5 times',
        expected: "fixture.press(' ').times(5);"
      },
      {
        name: "PRESS single-quoted space with quantification",
        input: "PRESS ' ' 5 times",
        expected: "fixture.press(' ').times(5);"
      },
      {
        name: 'PRESS single-quoted double-quote',
        input: "PRESS '\"'",
        expected: "fixture.press('\"').once();"
      },
      {
        name: 'PRESS double-quoted double-quote (escaped)',
        input: 'PRESS "\\""',
        expected: "fixture.press('\"').once();"
      },
      {
        name: 'PRESS unquoted double-quote',
        input: 'PRESS "',
        expected: "fixture.press('\"').once();"
      },
      {
        name: 'PRESS triple-quoted double-quote',
        input: 'PRESS """',
        expected: "fixture.press('\"').once();"
      },
      {
        name: 'PRESS single-quoted double-quote with quantification',
        input: "PRESS '\"' 3 times",
        expected: "fixture.press('\"').times(3);"
      },
      {
        name: 'PRESS double-quoted double-quote with quantification (escaped)',
        input: 'PRESS "\\"" 3 times',
        expected: "fixture.press('\"').times(3);"
      },
      {
        name: 'PRESS double-quoted single-quote',
        input: 'PRESS "\'"',
        expected: "fixture.press('\\'').once();"
      },
      {
        name: 'PRESS single-quoted single-quote (escaped)',
        input: "PRESS '\\''",
        expected: "fixture.press('\\'').once();"
      },
      {
        name: 'PRESS unquoted single-quote',
        input: "PRESS '",
        expected: "fixture.press('\\'').once();"
      },
      {
        name: 'PRESS triple-quoted single-quote',
        input: "PRESS '''",
        expected: "fixture.press('\\'').once();"
      },
      {
        name: 'PRESS double-quoted single-quote with quantification',
        input: 'PRESS "\'" 3 times',
        expected: "fixture.press('\\'').times(3);"
      },
      {
        name: 'PRESS single-quoted single-quote with quantification (escaped)',
        input: "PRESS '\\'' 3 times",
        expected: "fixture.press('\\'').times(3);"
      },
      {
        name: 'REPEAT with unquoted comma in PRESS (should fail)',
        input: "REPEAT 1 times PRESS, , PRESS 'a'",
        expectedError: "PRESS commands must be quoted in REPEAT command"
      },
      {
        name: 'REPEAT with quoted comma in PRESS',
        input: "REPEAT 1 times PRESS ',' , PRESS 'a'",
        expected: "for (let i = 0; i < 1; i++) {\n  fixture.press(',').once();\n  fixture.press('a').once();\n}"
      }
    ];

    const resultsDiv = document.getElementById('test-results');

    tests.forEach(test => {
      const div = document.createElement('div');
      div.className = 'test-case';

      let output, passed, error;
      try {
        output = transpiler.transpile(test.input);
        if (test.expectedError) {
          // Expected an error but didn't get one
          passed = false;
        } else {
          passed = output === test.expected;
        }
      } catch (e) {
        error = e.message;
        if (test.expectedError) {
          // Expected an error
          passed = error === test.expectedError;
        } else {
          passed = false;
        }
      }

      div.innerHTML = `
        <h3>${test.name} <span class="${passed ? 'pass' : 'fail'}">${passed ? '✓' : '✗'}</span></h3>
        <div><strong>Input:</strong></div>
        <pre>${test.input || '(empty)'}</pre>
        <div><strong>Expected:</strong></div>
        <pre>${test.expectedError ? `Error: ${test.expectedError}` : test.expected || '(empty)'}</pre>
        <div><strong>Output:</strong></div>
        <pre>${error ? `Error: ${error}` : output || '(empty)'}</pre>
      `;

      resultsDiv.appendChild(div);
    });
  </script>
</body>
</html>
